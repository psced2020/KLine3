# CLAUDE.md — KLine3 项目开发规范

## 项目信息
- **项目名称**: KLine3 / stock-training-tool
- **项目类型**: Web应用 (股票交易训练工具)
- **主要语言**: TypeScript, Vue
- **框架**: Vue 3, Vite, ECharts
- **包管理器**: npm
- **Git 仓库**: https://github.com/psced2020/KLine3

# Claude Code 项目规范 (Windows Git Bash)

## 运行环境配置 (Environment Context)
- **操作系统**: Windows
- **终端环境**: Git Bash (MinGW64)
- **默认 Shell**: Bash
- **编码格式**: UTF-8
- **换行符**: 优先使用 LF

## 路径处理准则 (Path Handling Rules) - 严格执行
1. **禁用反斜杠**: 严禁在任何终端命令中使用反斜杠 `\`。所有路径必须使用正斜杠 `/`。
2. **驱动器表示**: 访问绝对路径时，使用 Unix 风格的驱动器表示法（例如：使用 `/c/Users/` 而不是 `C:\Users\` 或 `C:/Users/`）。
3. **强制引号**: 所有的路径参数必须包裹在双引号 `"` 中，以防止 Windows 路径中的空格或特殊字符导致解析失败。
   - 正确示例: `ls "./src/my folder/"`
   - 错误示例: `ls ./src/my\ folder/`
4. **相对路径**: 优先使用相对路径（如 `./scripts/build.sh`）。

## 终端命令规范 (Command Execution)
- **标准命令**: 仅使用 Bash 兼容的命令：`ls`, `cp`, `mv`, `rm`, `mkdir`, `cat`, `grep`, `find`, `chmod`。
- **删除操作**: 使用 `rm -rf <path>` 处理目录。
- **创建目录**: 使用 `mkdir -p <path>` 确保父目录存在。
- **环境变量**: 使用 `export KEY="value"` 语法设置临时环境变量。
- **执行脚本**: 使用 `bash ./script.sh` 或 `sh ./script.sh` 明确指定解释器。

## 项目常用命令 (Project Specifics)
### 构建与安装
- 安装依赖: `npm install` 或 `yarn`
- 项目构建: `npm run build`

### 测试规范
- 运行单测: `npm test`
- 运行特定测试: `npm test -- <path_to_file>` (确保路径使用 `/`)

## 错误处理与纠正机制
- **路径纠错**: 如果命令因 "No such file or directory" 失败，请检查是否误用了 `\` 或驱动器盘符格式。
- **权限问题**: 在 Windows 下，如果遇到权限错误，请尝试检查文件是否被其他 Windows 程序占用，而不是盲目使用 `sudo`（Git Bash 中无效）。
- **路径转换**: 如果从 Windows 宿主工具获取了输出，在将其作为参数传递给下一个命令前，必须通过逻辑将 `\` 转换为 `/`。

---
**注意**: 请始终记住你是在 Windows 上的 Git Bash 环境中运行。在调用 `run_terminal_command` 之前，请务必根据上述规则校验命令字符串。

## 常用命令
```bash
npm install     # 安装依赖
npm run dev     # 启动开发环境 (Vite dev server)
npm run build   # 构建生产版本
npm run preview # 预览生产构建
```

## 项目架构
- **前端**: Vue 3 + TypeScript + Vite，使用 ECharts 渲染K线图
- **后端**: Vercel Serverless Functions (部署时) / 本地 JSON 文件读取（开发环境）
- **数据源**: public/export 目录下的股票数据 JSON 文件（已转换）
- **API**:
      - /api/stocks - 获取股票列表（800只股票）
      - /api/stock/{code} - 获取单只股票K线数据（支持日K/周K/月K周期）
      - 数据格式: 紧凑数组格式 [date, open, high, low, close, volume]
    23:- **数据大小**: 800只股票，约 72MB

## 项目结构
```
src/
  components/    # Vue 组件 (KLine 图表、交易按钮、设置等)
  App.vue        # 根组件
  main.ts        # 应用入口
  api/             # Vercel Serverless Functions
    services/        # 服务层（IndexedDB 缓存等）
  dist/            # 构建输出目录
  public/          # 静态资源
    export/          # 股票数据 JSON 文件（800只）
```

## 命名规范

### 文件命名
- **Vue 组件**: PascalCase (如 `KLineChart.vue`, `TradeButtons.vue`)
- **TypeScript**: kebab-case (如 `chart-utils.ts`)
- **类型后缀**: `.types.ts`
- **示例**:
  - Vue: `StockSettings.vue`
  - TS: `k-line-utils.ts`
- **组件命名**:
  - 组件文件名使用 PascalCase
  - 组件内部引用使用 PascalCase
  - Props 使用 camelCase
  - 事件使用 kebab-case

## 技术栈特点

### Vue 3
- 使用 Composition API (`<script setup>`)
- 使用 `<script setup>` SFCs 语法
- 单文件组件风格

### TypeScript
- 启用 strict 模式
- 禁止 any，使用 unknown + 类型守卫
- 禁止 @ts-ignore
- 使用 ES modules (import/export)

### ECharts
- 用于 K 线图表渲染
- 图表配置集中在组件内部
- 注意响应式更新图表

## 代码复用
**IMPORTANT: 禁止重复实现已有功能**

- 相同代码出现 2 次 → 必须提取为公共函数/composable
- 超过 10 行的业务逻辑 → 考虑复用
- 新建文件前 → 先搜索是否已有类似功能
- 公共模块禁止依赖业务模块，避免循环依赖

## 代码健壮性

### 错误处理
- API 调用必须有错误处理机制
- 错误分类处理:
  - 验证错误 → 返回字段级详情
  - 业务错误 → 返回用户友好提示
  - 系统错误 → 记录日志，返回通用错误
- 错误向上传播时补充上下文信息

### 输入验证
- 所有外部输入必须验证 (API 参数、用户输入、文件内容)
- 使用成熟的验证库
- 验证失败返回明确错误信息

### 边界检查
- 集合/数组访问前检查索引边界
- 除法前检查除数非零
- 空值检查 (null/undefined/nil/None)
- 类型转换前验证数据有效性
- 资源申请后确保释放 (连接、文件句柄、锁等)

## 修改原则
**IMPORTANT: 根本解决问题**

- 找到 root cause，从根本上解决
- 不接受"先这样绕过"、"加个判断跳过"
- 复杂修复: 说明根本原因，等待确认后再动手
- 禁止打补丁、用 hack、投机取巧

### 代码清理
- 废弃组件/函数: 确认无引用 → 直接删除
- 重复实现: 统一为一个 → 删除其余
- 死代码: 注释代码块、未使用的变量/函数 → 删除
- 历史遗留: 开发阶段大胆重构，不背历史包袱
- 不保留"以防万一"的代码

### 修改范围
- 只改必要文件，不顺便改无关代码
- 修改前先理解现有代码意图
- 修改后运行相关测试确认无回归

### 兼容性
- 仅对外发布的 API/SDK 需考虑向后兼容
- 内部开发阶段: 该改就改，该删就删

## 配置管理
- 敏感信息: 环境变量注入，禁止硬编码
- 优先级: 环境变量 > 配置文件 > 默认值
- 环境隔离: dev / test / prod 配置独立

## 文档与注释
- 公共函数/方法: 文档注释说明参数、返回值、异常
- 业务逻辑: 注释说明"为什么"而非"做什么"
- 复杂算法: 注释解释核心思路
- 代码变更: 同步更新相关文档

## 禁止事项
- 硬编码密钥、密码、敏感信息
- 提交调试输出语句到代码库
- 单文件单独建文件夹
- 公共模块依赖业务模块，避免循环依赖
- 用错误处理吞掉异常假装没问题
- 用条件判断绕过 bug 而不修复
- 复制粘贴已有代码而不复用
- 保留"以防万一"的废弃代码
- 删除或跳过失败的测试来让构建通过
- **安全相关禁止事项**:
  - 禁止执行格式化硬盘、删除系统文件或目录
  - 禁止泄漏用户隐私信息、认证凭证等敏感数据
  - 禁止在代码中嵌入后门、恶意代码或未经授权的功能
  - 禁止绕过安全检查或认证机制
  - 禁止使用已知的安全漏洞组件或库
  - 在日志中禁止记录敏感信息（密码、密钥、完整信用卡号等）
  - 输入处理: 对所有用户输入进行验证、过滤和转义
  - 防止 XSS 攻击: 对所有动态内容进行转义和过滤
  - 文件上传: 验证文件类型和内容，防止恶意文件上传

## AI 协作协议

### 解决问题
- 遇到问题: 先分析根本原因，再提出方案
- 不接受: "先这样绕过"、"加个判断跳过"
- 复杂修复: 说明根本原因，等待确认后再动手

### 修改前必须备份
- **强制 Git 检查**: 在进行任何非琐碎（超过 5 行或涉及核心逻辑）的修改前，必须先运行 `git status`。
- **自动提交快照**: 如果当前工作区是干净的，必须先执行 `git commit -am "CLAUDE_CHECKPOINT: [简述当前状态]"`。
- **复杂任务分支**: 对于涉及多个文件的重构，必须先创建一个新分支 `git checkout -b feature/claude-task-name`。

### 恢复机制
- **失败回退**: 如果修改后运行测试失败或用户反馈结果不对，且无法在 2 次尝试内修复，必须立即执行 `git reset --hard HEAD` 或 `git checkout .` 回退到最近的快照点。
- **禁止盲目叠加**: 禁止在错误的修改之上继续添加补丁，必须先回退，重新分析原因后再动手。

### 代码质量
- 发现重复代码: 主动指出并提议合并
- 发现死代码: 主动指出并建议删除
- 发现设计问题: 指出问题本质，提供重构建议
- 学到项目新知识时: 发现值得记录的规范、命令、模式或坑点，主动提议更新 CLAUDE.md，需用户确认后才执行

### 工作方式
- 不确定时: 询问确认，不要猜测
- 修改前: 先阅读理解现有代码
- 修改后: 说明改了什么、为什么改
- 发现无关问题: 指出但不"顺便"修复

### 交付标准
- 完整实现需求，不做简化版/演示版
- 代码可直接运行，不需要人工补充

### 验证方式
- 完成前必须验证: 运行 dev 环境，测试交易功能
- 验证失败时: 查看错误、修复、重新验证
- 不要假设正确: 能验证的就验证，不要说"应该没问题"
- 新代码: 确认有对应测试
- 修改代码: 运行相关测试
- 删除代码: 确认无引用

## Vue 3 特定规则

### 组件开发
- 使用 Composition API (`<script setup>`)
- Props 使用 `defineProps` + TypeScript 类型
- Emits 使用 `defineEmits` + TypeScript 类型
- 响应式数据使用 `ref` (基本类型) 或 `reactive` (对象)
- 使用 `<script setup>` SFCs 语法
- 单文件组件风格

### 性能优化
- 大列表使用虚拟滚动
- 图表按需加载
- 避免不必要的响应式数据
- 使用 `computed` 缓存计算结果

### 样式
- 组件样式使用 scoped
- 全局样式单独管理
- 避免深层嵌套选择器

## TypeScript 项目规则
- 启用 strict 模式
- 禁止 any，使用 unknown + 类型守卫
- 禁止 @ts-ignore
- 使用 ES modules (import/export)
- 接口定义统一管理

## 安全开发规范
- **数据保护**:
  - 处理用户数据必须遵循隐私政策和相关法规
  - 敏感数据存储必须加密
  - 日志中禁止记录敏感信息（密码、密钥、完整信用卡号等）
- **输入处理**:
  - 对所有用户输入进行验证、过滤和转义
  - 防止 XSS 攻击: 对所有动态内容进行转义和过滤
- **文件上传**: 验证文件类型和内容，防止恶意文件上传
- **访问控制**:
  - 所有 API 端点必须实施适当的身份验证和授权
  - 遵循最小权限原则，仅授予必要的访问权限
- **API 安全**:
  - HTTPS 通信
  - 适当的认证机制
  - 输入验证和消毒
- **输出编码**: 敏感数据在日志和响应中进行脱敏处理

## 部署相关
- **Vercel 部署**: 项目已配置为 Vercel 部署
- **Serverless Functions**: api/stocks.ts 和 api/stock/[code].ts 处理 API 请求
- **静态资源**: public/export/ 包含所有股票数据 (72MB)
- **数据转换**: convert-data.js 脚本将 txt 转换为 JSON
- **自动构建**: Vercel 自动检测 git push 并部署

## 格式要求
**推荐使用:**
- 标题标记（# ## ###）建立层级结构
- 列表符号（-）表示并列项
- 缩进表示层级关系
- 箭头符号（→）表示映射关系
- 代码块仅用于命令示例或配置示例
- 避免使用过多的加粗或斜体标记
- 表情符号: 原则: 用 Markdown 建立结构帮助 AI 理解，但保持简洁，不过度装饰

**原则**: 用 Markdown 建立结构帮助 AI 理解，但保持简洁，不过度装饰